{{ $tags := $.Site.Data.theme.conf.tags.xml }}
{{ $iframetagopen := $tags.iframetagopen }}
{{ $iframetagclose := $tags.iframetagclose }}
{{ $iframetagsrc := $tags.iframetagsrc }}

{{ $amazontags := $.Site.Data.affiliates.amazon }}
{{ if eq $amazontags nil }}{{ errorf "Missing affiliates amazon tags info: %s" .Position }}{{ end }}

{{ $ttags := split (default "" .Params.tags) "," }}
{{ $tlinkids := slice }}
{{ $tasins := slice }}

{{ range $ttag := $ttags }}
  {{ if and (ne $ttag nil) (ne $ttag "") }}
    {{ $t := index $amazontags $ttag }}
    {{ if eq $t nil }}{{ errorf "Missing affiliates amazon tag %s info" $ttag }}{{ end }}
    {{ if or (eq (index $t "linkids") "") (eq (index $t "asins") "") }}{{ errorf "Empty amazon tag linkids or asins %s info" $ttag }}{{ end }}

    {{ $tlinkids = $tlinkids | append (split (index $t "linkids") ",") }}
    {{ $tasins = $tasins | append (split (index $t "asins") ",") }}
  {{ end }}
{{ end }}

{{ $linkids := $tlinkids }}
{{ $asins := $tasins }}
{{ if isset .Params "linkids" }}
  {{ $linkids = $linkids | append (split .Params.linkids ",") }}
{{ end }}
{{ if isset .Params "asins" }}
  {{ $asins = $asins | append (split .Params.asins ",") }}
{{ end }}

{{ if or (gt (len $linkids) 0) (gt (len $asins) 0) }}
{{ if ne (len $linkids) (len $asins) }}
  {{ errorf "Invalid number linkids (%d) and asins (%d) (%s, %s): %s" (len $linkids) (len $asins) (delimit $linkids ",") (delimit $asins ",") .Position }}
{{ end }}
<div class="media media-amazon">
  {{- range $index, $linkid := $linkids -}}
  {{- $asin := index $asins $index -}}
  {{- $link := print "https://rcm-eu.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=blobit-21&language=es_ES&o=30&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=" $asin "&linkId=" $linkid }}
  {{ $iframetagopen | safeHTML }} style="width:120px;height:240px;" width="120" height="240" scrolling="no" frameborder="0" {{ $iframetagsrc }}="{{ $link }}" title="Amazon" class="lozad">{{ $iframetagclose | safeHTML }}
  {{- end }}
</div>
{{ end }}